<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Messages - StudyScribe</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 2px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="bg-gray-100">
    <div class="flex h-screen overflow-hidden">
        <!-- Main Content -->
        <div class="relative flex flex-col flex-1 overflow-hidden">
            <!-- Header -->
            <header class="sticky top-0 bg-white/80 backdrop-blur-sm border-b border-gray-200 z-30">
                <nav class="container mx-auto px-4 lg:px-8 flex justify-between items-center py-3">
                    <a href="#" class="flex items-center gap-3">
                        <span class="inline-flex h-10 w-10 items-center justify-center rounded-lg bg-gradient-to-tr from-purple-600 to-cyan-500 text-white shadow-md font-bold">SS</span>
                        <span class="font-extrabold tracking-tight text-2xl text-gray-800">Writer Messenger</span>
                    </a>
                    <div id="profile-menu-container" class="relative hidden">
                        <button id="profile-menu-button" class="flex items-center"><img id="navbar-profile-image" class="w-10 h-10 rounded-full object-cover" src="https://api.dicebear.com/9.x/initials/svg?seed=W" alt="User Profile"></button>
                        <div id="profile-menu-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 ring-1 ring-black ring-opacity-5">
                            <a href="./writer-dashboard.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">My Profile</a>
                            <a href="#" id="logout-btn" class="block px-4 py-2 text-sm text-red-600 hover:bg-red-50">Logout</a>
                        </div>
                    </div>
                </nav>
            </header>

            <!-- Chat Interface -->
            <div class="flex flex-1 overflow-hidden">
                <!-- Left Panel: Student List -->
                <aside class="w-full md:w-1/3 lg:w-1/4 bg-white border-r border-gray-200 flex flex-col">
                    <div class="p-4 border-b">
                        <h2 class="text-xl font-bold">Student Conversations</h2>
                    </div>
                    <div id="user-list" class="flex-1 overflow-y-auto custom-scrollbar">
                        <div id="loading-users" class="p-4 text-center text-gray-500">Loading students...</div>
                    </div>
                </aside>

                <!-- Right Panel: Chat Window -->
                <main class="flex-1 flex flex-col">
                    <!-- Placeholder View -->
                    <div id="chat-placeholder" class="flex-1 flex flex-col items-center justify-center text-center p-8">
                        <i data-lucide="messages-square" class="w-24 h-24 text-gray-300"></i>
                        <h2 class="mt-4 text-2xl font-bold text-gray-700">Select a Conversation</h2>
                        <p class="text-gray-500">Choose a student from the left panel to view messages.</p>
                    </div>

                    <!-- Active Chat View (hidden by default) -->
                    <div id="active-chat" class="hidden flex-1 flex flex-col">
                        <!-- Chat Header -->
                        <div class="flex items-center justify-between p-3 border-b bg-white">
                            <div class="flex items-center gap-3">
                                <img id="chat-header-image" src="" class="w-10 h-10 rounded-full object-cover">
                                <h3 id="chat-header-name" class="font-bold"></h3>
                            </div>
                        </div>

                        <!-- Messages -->
                        <div id="messages-container" class="flex-1 p-4 overflow-y-auto custom-scrollbar space-y-4">
                            <!-- Messages will be populated here -->
                        </div>

                        <!-- Message Input -->
                        <div class="p-4 bg-white border-t">
                            <form id="message-form" class="flex items-center gap-2">
                                <input type="text" id="message-input" placeholder="Type your reply..." autocomplete="off" class="flex-1 w-full px-4 py-2 bg-gray-100 rounded-full focus:outline-none focus:ring-2 focus:ring-purple-500">
                                <button type="submit" class="p-3 rounded-full bg-purple-600 text-white hover:bg-purple-700">
                                    <i data-lucide="send" class="w-5 h-5"></i>
                                </button>
                            </form>
                        </div>
                    </div>
                </main>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, getDocs, onSnapshot, addDoc, query, where, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCWe8cVgxALsLWESxf7kdFiFbhYTj4JQtQ",
            authDomain: "campusreach-c57e0.firebaseapp.com",
            projectId: "campusreach-c57e0",
            storageBucket: "campusreach-c57e0.firebasestorage.app",
            messagingSenderId: "294813850577",
            appId: "1:294813850577:web:49cd5cbe8240d486105ef0"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let currentUser = null;
        let currentChatId = null;
        let unsubscribeMessages = null;

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userDocRef = doc(db, "users", user.uid);
                const docSnap = await getDoc(userDocRef);
                if (docSnap.exists() && docSnap.data().role === 'writer') {
                    currentUser = { uid: user.uid, ...docSnap.data() };
                    setupUI(currentUser);
                    await fetchStudents(currentUser);
                } else {
                    // If not a writer, redirect away
                    window.location.href = "login.html";
                }
            } else {
                window.location.href = "login.html";
            }
        });

        function setupUI(user) {
            document.getElementById('navbar-profile-image').src = user.profileImage || `https://api.dicebear.com/9.x/initials/svg?seed=${user.fullname}`;
            document.getElementById('profile-menu-container').classList.remove('hidden');
            lucide.createIcons();
        }

        async function fetchStudents(loggedInWriter) {
            const userListEl = document.getElementById('user-list');
            const q = query(collection(db, "users"), where("role", "==", "student"));
            const querySnapshot = await getDocs(q);
            
            userListEl.innerHTML = '';
            let usersFound = false;

            querySnapshot.forEach((doc) => {
                const userData = doc.data();
                usersFound = true;
                const userItem = document.createElement('div');
                userItem.className = 'flex items-center gap-3 p-3 cursor-pointer hover:bg-gray-100 border-b';
                userItem.setAttribute('data-uid', userData.uid);
                userItem.setAttribute('data-name', userData.fullname);
                userItem.setAttribute('data-image', userData.profileImage || `https://api.dicebear.com/9.x/initials/svg?seed=${userData.fullname}`);
                userItem.innerHTML = `
                    <img src="${userData.profileImage || `https://api.dicebear.com/9.x/initials/svg?seed=${userData.fullname}`}" class="w-12 h-12 rounded-full object-cover">
                    <div>
                        <p class="font-bold">${userData.fullname}</p>
                        <p class="text-sm text-gray-500 capitalize">${userData.role}</p>
                    </div>
                `;
                userListEl.appendChild(userItem);
            });
            document.getElementById('loading-users').classList.add('hidden');
            if(!usersFound) {
                 userListEl.innerHTML = `<p class="p-4 text-center text-gray-500">No students found.</p>`;
            }
        }
        
        document.getElementById('user-list').addEventListener('click', (e) => {
            const userItem = e.target.closest('[data-uid]');
            if (userItem) {
                document.querySelectorAll('#user-list > div').forEach(div => div.classList.remove('bg-purple-50'));
                userItem.classList.add('bg-purple-50');

                const otherUserId = userItem.dataset.uid;
                const otherUserName = userItem.dataset.name;
                const otherUserImage = userItem.dataset.image;

                document.getElementById('chat-placeholder').classList.add('hidden');
                document.getElementById('active-chat').classList.remove('hidden');
                document.getElementById('chat-header-name').textContent = otherUserName;
                document.getElementById('chat-header-image').src = otherUserImage;

                currentChatId = [currentUser.uid, otherUserId].sort().join('_');
                loadMessages(currentChatId);
            }
        });

        function loadMessages(chatId) {
            const messagesContainer = document.getElementById('messages-container');
            if (unsubscribeMessages) unsubscribeMessages();

            const messagesQuery = query(collection(db, 'chats', chatId, 'messages'), orderBy('timestamp'));
            
            unsubscribeMessages = onSnapshot(messagesQuery, (snapshot) => {
                messagesContainer.innerHTML = ''; 
                snapshot.forEach(doc => displayMessage(doc.data()));
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            });
        }

        function displayMessage(message) {
            const messagesContainer = document.getElementById('messages-container');
            const wrapper = document.createElement('div');
            const bubble = document.createElement('div');
            const isSent = message.senderId === currentUser.uid;

            wrapper.className = `flex items-end gap-2 max-w-lg ${isSent ? 'ml-auto flex-row-reverse' : ''}`;
            bubble.className = `p-3 rounded-lg shadow-sm ${isSent ? 'bg-purple-600 text-white rounded-br-none' : 'bg-white border rounded-bl-none'}`;
            bubble.textContent = message.text;
            
            wrapper.appendChild(bubble);
            messagesContainer.appendChild(wrapper);
        }

        document.getElementById('message-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const messageInput = document.getElementById('message-input');
            const messageText = messageInput.value.trim();

            if (messageText && currentChatId && currentUser) {
                const messagesColRef = collection(db, 'chats', currentChatId, 'messages');
                await addDoc(messagesColRef, {
                    text: messageText,
                    senderId: currentUser.uid,
                    senderName: currentUser.fullname,
                    timestamp: serverTimestamp()
                });
                messageInput.value = '';
            }
        });

        const profileMenuButton = document.getElementById('profile-menu-button');
        const profileMenuDropdown = document.getElementById('profile-menu-dropdown');
        profileMenuButton.addEventListener('click', () => profileMenuDropdown.classList.toggle('hidden'));
        window.addEventListener('click', (e) => { if (profileMenuButton && !profileMenuButton.contains(e.target)) profileMenuDropdown.classList.add('hidden'); });
        document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));
    </script>
</body>
</html>

