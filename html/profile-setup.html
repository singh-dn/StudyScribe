<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Your Writer Profile - StudyScribe</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #F8F9FA; }
        .form-input {
            margin-top: 0.25rem; display: block; width: 100%; padding: 0.75rem;
            border: 1px solid #D1D5DB; border-radius: 0.5rem;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); transition: all 0.2s ease-in-out;
        }
        .form-input:focus, .form-input:focus-within {
            outline: none; border-color: #6366F1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }
        #toast-container { position: fixed; top: 1.5rem; right: 1.5rem; z-index: 10000; display: flex; flex-direction: column; gap: 0.75rem; }
        .toast { display: flex; align-items: center; padding: 1rem 1.25rem; border-radius: 0.75rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); animation: toast-in 0.3s ease-out forwards; max-width: 350px; }
        .toast.hiding { animation: toast-out 0.3s ease-in forwards; }
        .toast-success { background-color: #F0FFF4; border: 1px solid #C6F6D5; color: #2F855A; }
        .toast-error { background-color: #FFF5F5; border: 1px solid #FEB2B2; color: #C53030; }
        @keyframes toast-in { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes toast-out { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }
        .form-section-divider { border-top: 1px solid #e5e7eb; margin-top: 1.5rem; padding-top: 1.5rem; }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">
    <div id="toast-container"></div>
    <div id="setup-container" class="w-full max-w-4xl mx-auto hidden">
        <div class="bg-white rounded-xl shadow-lg p-8 md:p-12">
            <div class="text-center mb-8">
                 <a href="#" class="inline-flex items-center gap-3">
                    <span class="inline-flex h-10 w-10 items-center justify-center rounded-lg bg-gradient-to-tr from-purple-600 to-cyan-500 text-white shadow-md font-bold">SS</span>
                </a>
                <h1 class="text-3xl font-bold text-gray-800 mt-4">Complete Your Writer Profile</h1>
                <p class="text-gray-500 mt-2">Provide your details to build a trustworthy and professional profile.</p>
            </div>
            
            <form id="profile-setup-form" class="space-y-6" novalidate>
                
                <!-- Personal Information -->
                <div class="form-section-divider">
                     <h3 class="text-lg font-semibold text-gray-900">Personal Information</h3>
                </div>
                <div class="flex flex-col items-center space-y-4">
                    <div class="relative w-28 h-28">
                        <img id="profile-image-preview" src="https://api.dicebear.com/9.x/initials/svg?seed=Writer" alt="Profile Picture" class="w-28 h-28 rounded-full object-cover border-4 border-gray-100 shadow">
                        <label for="profile-image-upload" class="absolute bottom-0 right-0 bg-purple-600 text-white rounded-full p-2 cursor-pointer hover:bg-purple-700 transition">
                            <i data-lucide="camera" class="w-4 h-4"></i>
                            <input type="file" id="profile-image-upload" class="hidden" accept="image/*" required>
                        </label>
                    </div>
                     <p class="text-sm text-gray-500">A professional profile picture is required.</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="fullname" class="text-sm font-medium text-gray-700">Full Name</label>
                        <input type="text" id="fullname" class="form-input" required>
                    </div>
                    <div>
                        <label for="email" class="text-sm font-medium text-gray-700">Email</label>
                        <input type="email" id="email" class="form-input bg-gray-100 cursor-not-allowed" disabled>
                    </div>
                </div>
                
                <!-- Academic Information -->
                 <div class="form-section-divider">
                     <h3 class="text-lg font-semibold text-gray-900">Academic Background</h3>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="study-background" class="text-sm font-medium text-gray-700">Highest Qualification</label>
                        <input type="text" id="study-background" class="form-input" placeholder="e.g., MCA, B.Tech in CS" required>
                    </div>
                     <div>
                        <label for="college-name-full" class="text-sm font-medium text-gray-700">Full College Name</label>
                        <input type="text" id="college-name-full" class="form-input" placeholder="e.g., K. J. Somaiya College of Engineering" required>
                    </div>
                </div>
                <div>
                    <label for="college-address" class="text-sm font-medium text-gray-700">College Address</label>
                    <textarea id="college-address" rows="3" class="form-input" placeholder="e.g., Vidyanagar, Vidyavihar East, Mumbai, Maharashtra 400077" required></textarea>
                </div>

                <!-- Professional Details -->
                 <div class="form-section-divider">
                     <h3 class="text-lg font-semibold text-gray-900">Professional Details</h3>
                </div>
                 <div>
                    <label class="text-sm font-medium text-gray-700">Services You Offer (Select at least one)</label>
                    <div class="mt-2 grid grid-cols-2 sm:grid-cols-3 gap-3">
                        <label class="flex items-center space-x-2 border rounded-md p-3 hover:bg-gray-50 cursor-pointer"><input type="checkbox" name="services" value="essay_writing" class="rounded text-purple-600 focus:ring-purple-500"><span class="text-sm">Essay Writing</span></label>
                        <label class="flex items-center space-x-2 border rounded-md p-3 hover:bg-gray-50 cursor-pointer"><input type="checkbox" name="services" value="proofreading" class="rounded text-purple-600 focus:ring-purple-500"><span class="text-sm">Proofreading</span></label>
                        <label class="flex items-center space-x-2 border rounded-md p-3 hover:bg-gray-50 cursor-pointer"><input type="checkbox" name="services" value="tutoring" class="rounded text-purple-600 focus:ring-purple-500"><span class="text-sm">Tutoring</span></label>
                        <label class="flex items-center space-x-2 border rounded-md p-3 hover:bg-gray-50 cursor-pointer"><input type="checkbox" name="services" value="code_debugging" class="rounded text-purple-600 focus:ring-purple-500"><span class="text-sm">Code Debugging</span></label>
                        <label class="flex items-center space-x-2 border rounded-md p-3 hover:bg-gray-50 cursor-pointer"><input type="checkbox" name="services" value="research_paper" class="rounded text-purple-600 focus:ring-purple-500"><span class="text-sm">Research Papers</span></label>
                        <label class="flex items-center space-x-2 border rounded-md p-3 hover:bg-gray-50 cursor-pointer"><input type="checkbox" name="services" value="presentations" class="rounded text-purple-600 focus:ring-purple-500"><span class="text-sm">Presentations</span></label>
                    </div>
                </div>
                 <div>
                    <label for="writer-skills" class="text-sm font-medium text-gray-700">Top Skills/Subjects (comma separated)</label>
                    <input id="writer-skills" type="text" placeholder="e.g., Data Structures, Python, Calculus" class="form-input" required>
                </div>
                <div>
                    <label for="writer-bio" class="text-sm font-medium text-gray-700">Short Bio</label>
                    <textarea id="writer-bio" rows="4" placeholder="Tell students a little about yourself, your experience, and your expertise..." class="form-input" required></textarea>
                </div>

                <!-- Location Information -->
                <div class="form-section-divider">
                    <div class="flex justify-between items-center">
                        <h3 class="text-lg font-semibold text-gray-900">Your Location</h3>
                        <button type="button" id="get-location-btn" class="text-sm font-medium text-purple-600 hover:text-purple-800 flex items-center gap-1">
                            <i data-lucide="map-pin" class="w-4 h-4"></i> Use my current location
                        </button>
                    </div>
                </div>
                <div>
                    <label for="writer-address" class="text-sm font-medium text-gray-700">Full Address</label>
                    <textarea id="writer-address" rows="3" class="form-input" placeholder="House No, Street, Landmark" required></textarea>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div><label for="writer-city" class="text-sm font-medium text-gray-700">City</label><input type="text" id="writer-city" class="form-input" required></div>
                    <div><label for="writer-state" class="text-sm font-medium text-gray-700">State</label><input type="text" id="writer-state" class="form-input" required></div>
                    <div><label for="writer-pincode" class="text-sm font-medium text-gray-700">Pincode</label><input type="text" id="writer-pincode" class="form-input" required></div>
                </div>

                <!-- Social Profiles -->
                <div class="form-section-divider">
                    <h3 class="text-lg font-semibold text-gray-900">Social Profiles (Optional)</h3>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="linkedin-url" class="text-sm font-medium text-gray-700">LinkedIn Profile URL</label>
                        <input type="url" id="linkedin-url" class="form-input" placeholder="https://linkedin.com/in/yourprofile">
                    </div>
                     <div>
                        <label for="github-url" class="text-sm font-medium text-gray-700">GitHub Profile URL</label>
                        <input type="url" id="github-url" class="form-input" placeholder="https://github.com/yourusername">
                    </div>
                </div>

                 <!-- Verification Documents -->
                 <div class="form-section-divider">
                    <h3 class="text-lg font-semibold text-gray-900">Verification Documents</h3>
                    <p class="text-sm text-gray-500">These documents are required to verify your profile.</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-start">
                    <div>
                        <label class="text-sm font-medium text-gray-700">Handwriting Sample</label>
                        <img id="handwriting-preview" src="https://placehold.co/150x150/F3F4F6/9CA3AF?text=Preview" class="w-full h-32 mt-2 rounded-md object-cover border">
                        <label for="handwriting-image" class="mt-2 inline-block cursor-pointer bg-white border border-gray-300 rounded-md shadow-sm px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50">Upload Image</label>
                        <input id="handwriting-image" type="file" class="sr-only" accept="image/*" required>
                    </div>
                     <div>
                        <label class="text-sm font-medium text-gray-700">Notes Sample</label>
                         <p id="notes-filename" class="mt-2 text-xs text-gray-500 p-3 border rounded-md bg-gray-50 break-words">No file selected.</p>
                        <label for="notes-sample" class="mt-2 inline-block cursor-pointer bg-white border border-gray-300 rounded-md shadow-sm px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50">Upload File (PDF/DOC)</label>
                        <input id="notes-sample" type="file" class="sr-only" accept=".pdf,.doc,.docx" required>
                    </div>
                     <div>
                        <label class="text-sm font-medium text-gray-700">Certification</label>
                        <p id="certification-filename" class="mt-2 text-xs text-gray-500 p-3 border rounded-md bg-gray-50 break-words">No file selected.</p>
                        <label for="certification-upload" class="mt-2 inline-block cursor-pointer bg-white border border-gray-300 rounded-md shadow-sm px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50">Upload File (PDF/Image)</label>
                        <input id="certification-upload" type="file" class="sr-only" accept=".pdf,.jpg,.jpeg,.png" required>
                    </div>
                </div>
                
                <div class="pt-6">
                    <button type="submit" id="save-btn" class="w-full flex justify-center items-center py-3 px-4 border border-transparent rounded-full shadow-sm text-base font-medium text-white bg-gradient-to-r from-purple-600 to-cyan-500 hover:from-purple-700 hover:to-cyan-600 transition">
                        Save & Complete Profile
                    </button>
                </div>
            </form>
        </div>
    </div>
    
     <div id="loading-state" class="text-center py-20">
        <h1 class="text-2xl font-bold text-gray-700">Authenticating...</h1>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCWe8cVgxALsLWESxf7kdFiFbhYTj4JQtQ",
            authDomain: "campusreach-c57e0.firebaseapp.com",
            projectId: "campusreach-c57e0",
            storageBucket: "campusreach-c57e0.firebasestorage.app",
            messagingSenderId: "294813850577",
            appId: "1:294813850577:web:49cd5cbe8240d486105ef0"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        let currentUser = null;

        const showToast = (message, type = 'error') => {
            const toastContainer = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type === 'success' ? 'success' : 'error'}`;
            toast.textContent = message;
            toastContainer.appendChild(toast);
            setTimeout(() => {
                toast.classList.add('hiding');
                toast.addEventListener('animationend', () => toast.remove());
            }, 3000);
        };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                const userDocRef = doc(db, "users", user.uid);
                const docSnap = await getDoc(userDocRef);

                if (docSnap.exists()) {
                    const userData = docSnap.data();
                    if (userData.role !== 'writer') {
                        window.location.href = "/html/profile-setup.html"; 
                        return;
                    }
                    document.getElementById('email').value = user.email;
                    document.getElementById('fullname').value = userData.fullname || user.displayName || '';
                    if (userData.profileImage) {
                         document.getElementById('profile-image-preview').src = userData.profileImage;
                    }
                }
                document.getElementById('loading-state').classList.add('hidden');
                document.getElementById('setup-container').classList.remove('hidden');
                lucide.createIcons();
            } else {
                window.location.href = "/html/login.html";
            }
        });
        
        function setupFileInput(inputId, previewId, filenameId) {
            const input = document.getElementById(inputId);
            const preview = document.getElementById(previewId);
            const filenameEl = document.getElementById(filenameId);

            input.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    if(filenameEl) filenameEl.textContent = file.name;
                    if (preview && file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            preview.src = event.target.result;
                        }
                        reader.readAsDataURL(file);
                    }
                }
            });
        }
        
        setupFileInput('profile-image-upload', 'profile-image-preview', null);
        setupFileInput('handwriting-image', 'handwriting-preview', null);
        setupFileInput('notes-sample', null, 'notes-filename');
        setupFileInput('certification-upload', null, 'certification-filename');
        
        // Geolocation Logic
        document.getElementById('get-location-btn').addEventListener('click', () => {
             if (!navigator.geolocation) {
                showToast('Geolocation is not supported by your browser.', 'error');
                return;
            }

            navigator.geolocation.getCurrentPosition(async (position) => {
                const { latitude, longitude } = position.coords;
                showToast('Location fetched! Getting address details...', 'success');
                try {
                    const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`);
                    const data = await response.json();
                    
                    if (data.address) {
                        document.getElementById('writer-address').value = data.display_name.split(',').slice(0, -3).join(',');
                        document.getElementById('writer-city').value = data.address.city || data.address.town || data.address.village || '';
                        document.getElementById('writer-state').value = data.address.state || '';
                        document.getElementById('writer-pincode').value = data.address.postcode || '';
                    }
                } catch (error) {
                    console.error('Error fetching address:', error);
                    showToast('Could not fetch address details.', 'error');
                }
            }, (error) => {
                showToast('Unable to retrieve your location. Please enter it manually.', 'error');
            });
        });


        document.getElementById('profile-setup-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) return;

            // --- Comprehensive Validation ---
            const requiredTextFields = ['fullname', 'study-background', 'college-name-full', 'college-address', 'writer-skills', 'writer-bio', 'writer-address', 'writer-city', 'writer-state', 'writer-pincode'];
            for (const id of requiredTextFields) {
                const element = document.getElementById(id);
                const label = element.previousElementSibling || element.parentElement.previousElementSibling;
                if (!element.value.trim()) {
                    showToast(`Please fill out the '${label.textContent}' field.`, 'error');
                    return;
                }
            }
            const services = Array.from(document.querySelectorAll('input[name="services"]:checked'));
            if (services.length === 0) {
                showToast('Please select at least one service you offer.', 'error'); return;
            }
            const requiredFiles = ['profile-image-upload', 'handwriting-image', 'notes-sample', 'certification-upload'];
             for (const id of requiredFiles) {
                if (document.getElementById(id).files.length === 0) {
                    const label = document.querySelector(`label[for="${id}"]`) || document.getElementById(id).closest('div').querySelector('label');
                    showToast(`Please upload your ${label.textContent}.`, 'error');
                    return;
                }
            }
            
            const saveBtn = document.getElementById('save-btn');
            saveBtn.disabled = true;
            saveBtn.textContent = 'Saving...';

            try {
                const userDocRef = doc(db, "users", currentUser.uid);
                const updatedData = {
                    fullname: document.getElementById('fullname').value,
                    studyBackground: document.getElementById('study-background').value,
                    collegeNameFull: document.getElementById('college-name-full').value,
                    collegeAddress: document.getElementById('college-address').value,
                    services: services.map(cb => cb.value),
                    skills: document.getElementById('writer-skills').value.split(',').map(s => s.trim()).filter(Boolean),
                    bio: document.getElementById('writer-bio').value,
                    writerLocation: {
                        address: document.getElementById('writer-address').value,
                        city: document.getElementById('writer-city').value,
                        state: document.getElementById('writer-state').value,
                        pincode: document.getElementById('writer-pincode').value,
                    },
                    socials: {
                        linkedin: document.getElementById('linkedin-url').value,
                        github: document.getElementById('github-url').value,
                    },
                    profileSetupComplete: true 
                };
                
                const uploadFile = async (fileInputId, folder, fileNamePrefix) => {
                    const file = document.getElementById(fileInputId).files[0];
                    if (!file) return null;
                    const storageRef = ref(storage, `${folder}/${currentUser.uid}/${fileNamePrefix}_${file.name}`);
                    await uploadBytes(storageRef, file);
                    return await getDownloadURL(storageRef);
                };

                const [profileImageUrl, handwritingImageUrl, notesSampleUrl, certificationUrl] = await Promise.all([
                    uploadFile('profile-image-upload', 'profilePictures', 'profile'),
                    uploadFile('handwriting-image', 'writerDocs', 'handwriting'),
                    uploadFile('notes-sample', 'writerDocs', 'notesSample'),
                    uploadFile('certification-upload', 'writerDocs', 'certification')
                ]);
        
                if (profileImageUrl) updatedData.profileImage = profileImageUrl;
                if (handwritingImageUrl) updatedData.handwritingImageUrl = handwritingImageUrl;
                if (notesSampleUrl) updatedData.notesSampleUrl = notesSampleUrl;
                if (certificationUrl) updatedData.certificationUrl = certificationUrl;
                
                await setDoc(userDocRef, updatedData, { merge: true });
                showToast('Profile saved successfully!', 'success');
                
                setTimeout(() => {
                    window.location.href = '/html/profile-preview(writer).html';
                }, 1500);

            } catch(error) {
                console.error("Error saving profile:", error);
                showToast('Failed to save profile. Please try again.', 'error');
            } finally {
                 saveBtn.disabled = false;
                 saveBtn.textContent = 'Save & Complete Profile';
            }
        });
    </script>
</body>
</html>

